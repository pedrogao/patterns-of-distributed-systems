<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>分布式系统模式 | Patterns of Distributed Systems</title>
    <meta name="description" content="《分布式系统模式》（Patterns of Distributed Systems）是 Unmesh Joshi 编写的一系列关于分布式系统实现的文章。这个系列的文章采用模式的格式，介绍了像 Kafka、Zookeeper 这种分布式系统在实现过程采用的通用模式，是学习分布式系统实现的基础。">
    <meta name="generator" content="VitePress v1.5.0">
    <link rel="preload stylesheet" href="/patterns-of-distributed-systems/assets/style.DTv6M9ie.css" as="style">
    <link rel="preload stylesheet" href="/patterns-of-distributed-systems/vp-icons.css" as="style">
    
    <script type="module" src="/patterns-of-distributed-systems/assets/app.sB_GWMR9.js"></script>
    <link rel="preload" href="/patterns-of-distributed-systems/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/patterns-of-distributed-systems/assets/chunks/theme.BodzPjWO.js">
    <link rel="modulepreload" href="/patterns-of-distributed-systems/assets/chunks/framework.DDPRMxUp.js">
    <link rel="modulepreload" href="/patterns-of-distributed-systems/assets/content_overview.md.ClyZ9akP.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-32300550><!--[--><!--]--><!--[--><span tabindex="-1" data-v-ba58bb4b></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-ba58bb4b> Skip to content </a><!--]--><!----><header class="VPNav" data-v-32300550 data-v-2d0eb4a0><div class="VPNavBar" data-v-2d0eb4a0 data-v-71c45a6d><div class="wrapper" data-v-71c45a6d><div class="container" data-v-71c45a6d><div class="title" data-v-71c45a6d><div class="VPNavBarTitle has-sidebar" data-v-71c45a6d data-v-6d63f5c9><a class="title" href="/patterns-of-distributed-systems/" data-v-6d63f5c9><!--[--><!--]--><!--[--><img class="VPImage logo" src="https://martinfowler.com/articles/patterns-of-distributed-systems/card.png" alt data-v-64bad313><!--]--><span data-v-6d63f5c9>Patterns of Distributed Systems</span><!--[--><!--]--></a></div></div><div class="content" data-v-71c45a6d><div class="content-body" data-v-71c45a6d><!--[--><!--]--><div class="VPNavBarSearch search" data-v-71c45a6d><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-71c45a6d data-v-32dc05b5><span id="main-nav-aria-label" class="visually-hidden" data-v-32dc05b5> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/patterns-of-distributed-systems/" tabindex="0" data-v-32dc05b5 data-v-46ecd2f3><!--[--><span data-v-46ecd2f3>主页</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/patterns-of-distributed-systems/content/overview.html" tabindex="0" data-v-32dc05b5 data-v-46ecd2f3><!--[--><span data-v-46ecd2f3>概述</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-32dc05b5 data-v-0a789497><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-0a789497><span class="text" data-v-0a789497><!----><span data-v-0a789497>模式</span><span class="vpi-chevron-down text-icon" data-v-0a789497></span></span></button><div class="menu" data-v-0a789497><div class="VPMenu" data-v-0a789497 data-v-d97d1dd3><div class="items" data-v-d97d1dd3><!--[--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/clock-bound-wait.html" data-v-ad163415><!--[--><span data-v-ad163415>以时钟为限的等待（Clock-Bound Wait）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/consistent-core.html" data-v-ad163415><!--[--><span data-v-ad163415>一致性内核（Consistent Core）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/emergent-leader.html" data-v-ad163415><!--[--><span data-v-ad163415>新生领导者（Emergent Leader）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/fixed-partitions.html" data-v-ad163415><!--[--><span data-v-ad163415>固定分区（Fixed Partitions）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/follower-reads.html" data-v-ad163415><!--[--><span data-v-ad163415>追随者读取（Follower Reads）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/generation-clock.html" data-v-ad163415><!--[--><span data-v-ad163415>世代时钟（Generation Clock）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/gossip-dissemination.html" data-v-ad163415><!--[--><span data-v-ad163415>Gossip 传播（Gossip Dissemination）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/heartbeat.html" data-v-ad163415><!--[--><span data-v-ad163415>心跳（HeartBeat）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/high-water-mark.html" data-v-ad163415><!--[--><span data-v-ad163415>高水位标记（High-Water Mark）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/hybrid-clock.html" data-v-ad163415><!--[--><span data-v-ad163415>混合时钟（Hybrid Clock）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/idempotent-receiver.html" data-v-ad163415><!--[--><span data-v-ad163415>幂等接收者（Idempotent Receiver）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/key-range-partitions.html" data-v-ad163415><!--[--><span data-v-ad163415>键值范围分区（Key-Range Partitions）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/lamport-clock.html" data-v-ad163415><!--[--><span data-v-ad163415>Lamport 时钟（Lamport Clock）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/leader-and-followers.html" data-v-ad163415><!--[--><span data-v-ad163415>领导者和追随者（Leader and Followers）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/lease.html" data-v-ad163415><!--[--><span data-v-ad163415>租约（Lease）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/low-water-mark.html" data-v-ad163415><!--[--><span data-v-ad163415>低水位标记（Low-Water Mark）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/paxos.html" data-v-ad163415><!--[--><span data-v-ad163415>Paxos</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/quorum.html" data-v-ad163415><!--[--><span data-v-ad163415>Quorum</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/replicated-log.html" data-v-ad163415><!--[--><span data-v-ad163415>复制日志（Replicated Log）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/request-batch.html" data-v-ad163415><!--[--><span data-v-ad163415>批量请求（Request Batch）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/request-pipeline.html" data-v-ad163415><!--[--><span data-v-ad163415>请求管道（Request Pipeline）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/request-waiting-list.html" data-v-ad163415><!--[--><span data-v-ad163415>请求等待列表（Request Waiting List）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/segmented-log.html" data-v-ad163415><!--[--><span data-v-ad163415>分段日志（Segmented Log）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/single-socket-channel.html" data-v-ad163415><!--[--><span data-v-ad163415>单一 Socket 通道（Single Socket Channel）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/singular-update-queue.html" data-v-ad163415><!--[--><span data-v-ad163415>单一更新队列（Singular Update Queue）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/state-watch.html" data-v-ad163415><!--[--><span data-v-ad163415>状态监控（State Watch）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/two-phase-commit.html" data-v-ad163415><!--[--><span data-v-ad163415>两阶段提交（Two Phase Commit）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/version-vector.html" data-v-ad163415><!--[--><span data-v-ad163415>版本向量（Version Vector）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/versioned-value.html" data-v-ad163415><!--[--><span data-v-ad163415>有版本的值（Versioned Values）</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/content/write-ahead-log.html" data-v-ad163415><!--[--><span data-v-ad163415>预写日志（Write-Ahead Log）</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-32dc05b5 data-v-0a789497><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-0a789497><span class="text" data-v-0a789497><!----><span data-v-0a789497>模式（新）</span><span class="vpi-chevron-down text-icon" data-v-0a789497></span></span></button><div class="menu" data-v-0a789497><div class="VPMenu" data-v-0a789497 data-v-d97d1dd3><div class="items" data-v-d97d1dd3><!--[--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/part2/Chapter%2012.%20High-Water%20Mark.html" data-v-ad163415><!--[--><span data-v-ad163415>High-Water Mark (高水位标记)</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-d97d1dd3 data-v-ad163415><a class="VPLink link" href="/patterns-of-distributed-systems/part2/Chapter%2015.%20Idempotent%20Receiver.html" data-v-ad163415><!--[--><span data-v-ad163415>Idempotent Receiver（幂等接收者）</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-71c45a6d data-v-22bf22f6><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-22bf22f6 data-v-29fc1bfe data-v-7ac35f5c><span class="check" data-v-7ac35f5c><span class="icon" data-v-7ac35f5c><!--[--><span class="vpi-sun sun" data-v-29fc1bfe></span><span class="vpi-moon moon" data-v-29fc1bfe></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-71c45a6d data-v-4f2173d3 data-v-11e139c6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/pedrogao/patterns-of-distributed-systems" aria-label="github" target="_blank" rel="noopener" data-v-11e139c6 data-v-3c8bd2ea><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-71c45a6d data-v-e083eb74 data-v-0a789497><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-0a789497><span class="vpi-more-horizontal icon" data-v-0a789497></span></button><div class="menu" data-v-0a789497><div class="VPMenu" data-v-0a789497 data-v-d97d1dd3><!----><!--[--><!--[--><!----><div class="group" data-v-e083eb74><div class="item appearance" data-v-e083eb74><p class="label" data-v-e083eb74>Appearance</p><div class="appearance-action" data-v-e083eb74><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-e083eb74 data-v-29fc1bfe data-v-7ac35f5c><span class="check" data-v-7ac35f5c><span class="icon" data-v-7ac35f5c><!--[--><span class="vpi-sun sun" data-v-29fc1bfe></span><span class="vpi-moon moon" data-v-29fc1bfe></span><!--]--></span></span></button></div></div></div><div class="group" data-v-e083eb74><div class="item social-links" data-v-e083eb74><div class="VPSocialLinks social-links-list" data-v-e083eb74 data-v-11e139c6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/pedrogao/patterns-of-distributed-systems" aria-label="github" target="_blank" rel="noopener" data-v-11e139c6 data-v-3c8bd2ea><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-71c45a6d data-v-e43cb5b3><span class="container" data-v-e43cb5b3><span class="top" data-v-e43cb5b3></span><span class="middle" data-v-e43cb5b3></span><span class="bottom" data-v-e43cb5b3></span></span></button></div></div></div></div><div class="divider" data-v-71c45a6d><div class="divider-line" data-v-71c45a6d></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-32300550 data-v-7146ecf1><div class="container" data-v-7146ecf1><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-7146ecf1><span class="vpi-align-left menu-icon" data-v-7146ecf1></span><span class="menu-text" data-v-7146ecf1>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-7146ecf1 data-v-7655a9ae><button data-v-7655a9ae>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-32300550 data-v-189310e7><div class="curtain" data-v-189310e7></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-189310e7><span class="visually-hidden" id="sidebar-aria-label" data-v-189310e7> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-1d987cc7><section class="VPSidebarItem level-0" data-v-1d987cc7 data-v-1c11c092><div class="item" role="button" tabindex="0" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><h2 class="text" data-v-1c11c092>模式</h2><!----></div><div class="items" data-v-1c11c092><!--[--><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/clock-bound-wait.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>以时钟为限的等待（Clock-Bound Wait）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/consistent-core.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>一致性内核（Consistent Core）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/emergent-leader.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>新生领导者（Emergent Leader）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/fixed-partitions.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>固定分区（Fixed Partitions）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/follower-reads.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>追随者读取（Follower Reads）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/generation-clock.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>世代时钟（Generation Clock）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/gossip-dissemination.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>Gossip 传播（Gossip Dissemination）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/heartbeat.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>心跳（HeartBeat）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/high-water-mark.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>高水位标记（High-Water Mark）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/hybrid-clock.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>混合时钟（Hybrid Clock）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/idempotent-receiver.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>幂等接收者（Idempotent Receiver）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/key-range-partitions.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>键值范围分区（Key-Range Partitions）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/lamport-clock.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>Lamport 时钟（Lamport Clock）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/leader-and-followers.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>领导者和追随者（Leader and Followers）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/lease.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>租约（Lease）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/low-water-mark.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>低水位标记（Low-Water Mark）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/paxos.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>Paxos</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/quorum.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>Quorum</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/replicated-log.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>复制日志（Replicated Log）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/request-batch.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>批量请求（Request Batch）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/request-pipeline.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>请求管道（Request Pipeline）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/request-waiting-list.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>请求等待列表（Request Waiting List）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/segmented-log.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>分段日志（Segmented Log）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/single-socket-channel.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>单一 Socket 通道（Single Socket Channel）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/singular-update-queue.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>单一更新队列（Singular Update Queue）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/state-watch.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>状态监控（State Watch）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/two-phase-commit.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>两阶段提交（Two Phase Commit）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/version-vector.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>版本向量（Version Vector）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/versioned-value.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>有版本的值（Versioned Values）</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-1c11c092 data-v-1c11c092><div class="item" data-v-1c11c092><div class="indicator" data-v-1c11c092></div><a class="VPLink link link" href="/patterns-of-distributed-systems/content/write-ahead-log.html" data-v-1c11c092><!--[--><p class="text" data-v-1c11c092>预写日志（Write-Ahead Log）</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-32300550 data-v-69761bbe><div class="VPDoc has-sidebar has-aside" data-v-69761bbe data-v-a5e516de><!--[--><!--]--><div class="container" data-v-a5e516de><div class="aside" data-v-a5e516de><div class="aside-curtain" data-v-a5e516de></div><div class="aside-container" data-v-a5e516de><div class="aside-content" data-v-a5e516de><div class="VPDocAside" data-v-a5e516de data-v-b88c11e1><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-b88c11e1 data-v-25e8580a><div class="content" data-v-25e8580a><div class="outline-marker" data-v-25e8580a></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-25e8580a>On this page</div><ul class="VPDocOutlineItem root" data-v-25e8580a data-v-150b2bd7><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-b88c11e1></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-a5e516de><div class="content-container" data-v-a5e516de><!--[--><!--]--><main class="main" data-v-a5e516de><div style="position:relative;" class="vp-doc _patterns-of-distributed-systems_content_overview" data-v-a5e516de><div><h1 id="分布式系统模式" tabindex="-1">分布式系统模式 <a class="header-anchor" href="#分布式系统模式" aria-label="Permalink to &quot;分布式系统模式&quot;">​</a></h1><p><strong>原文</strong></p><p><a href="https://martinfowler.com/articles/patterns-of-distributed-systems/" target="_blank" rel="noreferrer">https://martinfowler.com/articles/patterns-of-distributed-systems/</a></p><p>分布式系统给软件开发带来了一些特殊的挑战，要求数据有多个副本，且彼此间要保持同步。然而，我们不能保证所有工作节点都能可靠地工作，网络延迟会轻易地造成不一致。尽管如此，许多组织依然要依赖一系列核心的分布式软件来处理数据存储、消息通信、系统管理以及计算能力。这些系统面临着共同的问题，可以采用类似的方案解决。本文将这些方案进行分类，并进一步提炼成模式。通过模式，我们可以认识到如何更好的理解、交流和传授分布式系统设计。</p><p><strong>2022.9.7</strong></p><blockquote><p>Unmesh Joshi</p><p>Unmesh Joshi 是 ThoughtWorks 的总监级咨询师。他是一个软件架构的爱好者，相信在今天理解分布式系统的原则，同过去十年里理解 Web 架构或面向对象编程一样至关重要。</p></blockquote><h2 id="这个系列在讨论什么" tabindex="-1">这个系列在讨论什么 <a class="header-anchor" href="#这个系列在讨论什么" aria-label="Permalink to &quot;这个系列在讨论什么&quot;">​</a></h2><p>在过去的几个月里，我在 ThoughtWorks 内部组织了许多分布式系统的工作坊。在组织这些工作坊的过程中，我们面临的一个严峻挑战就是，如何将分布式系统的理论映射到诸如 Kafka 或Cassandra 这样的开源代码库上，同时，还要保持讨论足够通用，覆盖尽可能广泛的解决方案。模式的概念为此提供了一个不错的出路。</p><p>从模式的本质上说，其结构让我们可以专注在一个特定的问题上，这就很容易说清楚，为什么需要一个特定的解决方案。解决方案的描述让我们有了一个代码结构，对于展示一个实际的解决方案而言，它足够具体，对于涵盖广泛的变体而言，它又足够通用。模式技术还可以将不同的模式联系在一起，构建出一个完整的系统。由此，便有了一个讨论分布式系统实现非常好的词汇表。</p><p>下面就是从主流开源分布式系统中观察到的第一组模式。希望这组模式对所有的程序员都有用。</p><h3 id="分布式系统-一个实现的视角" tabindex="-1">分布式系统：一个实现的视角 <a class="header-anchor" href="#分布式系统-一个实现的视角" aria-label="Permalink to &quot;分布式系统：一个实现的视角&quot;">​</a></h3><p>今天的企业架构充满了各种天生就分布的平台和框架。如果从今天典型的企业应用架构选取典型平台和框架组成列表，我们可能会得到类似于下面这样一个列表：</p><table tabindex="0"><thead><tr><th style="text-align:left;"><strong>平台/框架的类型</strong></th><th style="text-align:left;"><strong>样例</strong></th></tr></thead><tbody><tr><td style="text-align:left;">数据库</td><td style="text-align:left;">Cassandra、HBase、Riak</td></tr><tr><td style="text-align:left;">消息队列</td><td style="text-align:left;">Kafka、Pulsar</td></tr><tr><td style="text-align:left;">基础设施</td><td style="text-align:left;">Kubernetes、Mesos、Zookeeper、etcd、Consul</td></tr><tr><td style="text-align:left;">内存数据/计算网格</td><td style="text-align:left;">Hazelcast、Pivotal、Gemfire</td></tr><tr><td style="text-align:left;">有状态微服务</td><td style="text-align:left;">Akka Actors、Axon</td></tr><tr><td style="text-align:left;">文件系统</td><td style="text-align:left;">HDFS、Ceph</td></tr></tbody></table><p>所有这些天生都是“分布式的”。对一个系统而言，分布式意味着什么呢？它包含两个方面：</p><ul><li>这个系统运行在多个服务器上。集群中的服务器数量差异极大，少则两三台，多则数千台。</li><li>这个系统管理着数据。因此，其本质上是一个“有状态”的系统。</li></ul><p>当多台服务器参与到存储数据中，总有一些地方会出错。上述所有提及的系统都需要解决这些问题。在这些系统的实现中，解决这些问题时总有一些类似的解决方案。以通用的形式理解这些解决方案，有助于在更大的范围内理解这些系统的实现，也可以当做构建新系统的指导原则。</p><p>好，进入模式。</p><h4 id="模式" tabindex="-1">模式 <a class="header-anchor" href="#模式" aria-label="Permalink to &quot;模式&quot;">​</a></h4><p><a href="https://martinfowler.com/articles/writingPatterns.html" target="_blank" rel="noreferrer">模式</a>，这是 Christopher Alexander 引入的一个概念，现在在软件设计社区得到了广泛地接受，用以记录在构建软件系统所用的各种设计构造。模式提供一种“从问题到解决方案”的结构化方式，它可以在许多地方见到，并且得到了证明。使用模式的一种有意思的方式是，采用模式序列或模式语言的形式，将多个模式联系在一起，这为实现“整个”或完整的系统提供了指导方向。将分布式系统视为一系列模式是一种有价值的做法，可以获得关于其实现更多的洞见。</p><h2 id="问题及可复用的解决方案" tabindex="-1">问题及可复用的解决方案 <a class="header-anchor" href="#问题及可复用的解决方案" aria-label="Permalink to &quot;问题及可复用的解决方案&quot;">​</a></h2><p>当数据要存储在多台服务器上时，有很多地方可能会出错。</p><h3 id="进程崩溃" tabindex="-1">进程崩溃 <a class="header-anchor" href="#进程崩溃" aria-label="Permalink to &quot;进程崩溃&quot;">​</a></h3><p>进程随时都会崩溃，无论是硬件故障，还是软件故障。进程崩溃的方式有许多种：</p><ul><li>系统管理员进行常规维护时，进程可能会挂掉</li><li>因为磁盘已满，异常未能正确处理，做一些文件 IO 时进程可能被杀掉</li><li>在云环境中，甚至更加诡异，一些无关因素都会让服务器宕机</li></ul><p>如果进程负责存储数据，底线是其设计要对存储在服务器上的数据给予一定的持久性（durability）保证。即便进程突然崩溃，所有已经通知用户成功存储的数据也要得以保障。依赖于其存储模式，不同的存储引擎有不同的的存储结构，从简单的哈希表到复杂的图存储。因为将数据写入磁盘是最耗时的过程，可能不是每个对存储的插入或更新都来得及写入到磁盘中。因此，大多数数据库都有内存存储结构，其只完成周期性的磁盘写入。这就增加了“进程突然崩溃丢失所有数据”的风险。</p><p>有一种叫<a href="./write-ahead-log.html">预写日志（Write-Ahead Log，简称 WAL）</a>的技术就是用来对付这种情况的。服务器存储将每个状态改变当做一个命令记录在硬盘上的一个只追加（append-only）的文件上。在文件上附加是一个非常快的操作，因此，它几乎对性能完全没有影响。这样一个可以顺序追加的日志可以存储每次更新。在服务器启动时，日志可以回放，以重建内存状态。</p><p>这就保证了持久性。即便服务器突然崩溃再重启，数据也不会丢失。但是，客户端在服务器恢复之前是不能获取或存储数据的。因此，在服务器失效时，我们缺乏了可用性。</p><p>一个显而易见的解决方案是将数据存储在多台服务器上。因此，我们可以将 WAL 复制到多台服务器上。</p><p>一旦有了多台服务器，就需要考虑更多的失效场景了。</p><h3 id="网络延迟" tabindex="-1">网络延迟 <a class="header-anchor" href="#网络延迟" aria-label="Permalink to &quot;网络延迟&quot;">​</a></h3><p>在 TCP/IP 协议栈中，跨网络传输消息的延迟并没有一个上限。由于网络负载，这个值差异会很大。比如，由于触发了一个大数据的任务，一个 1Gbps 的网络也可能会被吞噬，网络缓冲被填满，一些消息到达服务器的延迟可能会变得任意长。</p><p>在一个典型的数据中心里，服务器并排放在机架上，多个机架通过顶端的机架交换机连接在一起。可能还会有一棵交换机树，将数据中心的一部分同另外的部分连接在一起。在某些情况下，一组服务器可以彼此通信，却与另一组服务器断开连接。这种情况称为网络分区。服务器通过网络进行通信时，一个基本的问题就是，知道一个特定的服务器何时失效。</p><p>这里有两个问题要解决。</p><ul><li>一个特定的服务器不能为了知晓其它服务器是否已崩溃而无限期地等待。</li><li>不应该出现两组服务器，彼此都认为对方已经失效，因此，继续为不同的客户端提供服务，这种情况称为脑裂。</li></ul><p>要解决第一个问题，每个服务器都要以固定的间隔像其它服务器发送一个<a href="./heartbeat.html">心跳（HeartBeat）</a>消息。如果心跳丢失，那台服务器就会被认为是崩溃了。心跳间隔要足够小，确保检测到服务器失效并不需要花太长的时间。正如我们下面将要看到的那样，在最糟糕的情况下，服务器可能已经重新启动，集群作为一个整体依然认为这台服务器还在失效中，这样才能确保提供给客户端的服务不会就此中断。</p><p>第二个问题是脑裂。一旦产生脑裂，两组服务器就会独立接受更新，不同的客户端就会读写不同的数据，脑裂即便解决了，这些冲突也不可能自动得到解决。</p><p>要解决脑裂问题，必须确保两组失联的服务器不能独立地前进。为了确保这一点，服务器采取的每个动作，只有经过大多数服务器的确认之后，才能认为是成功的。如果服务器无法获得多数确认，就不能提供必要的服务。某些客户端可能无法获得服务，但服务器集群总能保持一致的状态。占多数的服务器的数量称为 <a href="./quorum.html">Quorum</a>。如何确定 Quorum 呢？这取决于集群所容忍的失效数量。如果有一个 5 个节点的集群，Quorum 就应该是 3。总的来说，如果想容忍 f 个失效，集群的规模就应该是 2f + 1。</p><p>Quorum 保证了我们拥有足够的数据副本，以拯救一些服务器的失效。但这不足以给客户端以强一致性保证。比如，一个客户在 Quorum 上发起了一个写操作，但该操作只在一台服务器上成功了。Quorum 上其它服务器依旧是原有的值。当客户端从这个 Quorum 上读取数据时，如果有最新值的服务器可用，它得到的就可能是最新的值。但是，如果客户端开始读取这个值时，有最新值的服务器不可用，它得到的就可能是一个原有的值了。为了避免这种情况，就需要有人追踪是否 Quorum 对于特定的操作达成了一致，只有那些在所有服务器上都可用的值才会发送给客户端。在这种场景下，会使用<a href="./leader-and-followers.html">领导者和追随者（Leader and Followers）</a>。领导者控制和协调在追随者上的复制。由领导者决定什么样的变化对于客户端是可见的。<a href="./high-water-mark.html">高水位标记（High Water Mark）</a>用于追踪在 WAL 上的项是否已经成功复制到 Quorum 的追随者上。所有达到高水位标记的条目就会对客户端可见。领导者还会将高水位标记传播给追随者。因此，当领导者出现失效时，某个追随者就会成为新的领导者，所以，从客户端的角度看，是不会出现不一致的。</p><h3 id="进程暂停" tabindex="-1">进程暂停 <a class="header-anchor" href="#进程暂停" aria-label="Permalink to &quot;进程暂停&quot;">​</a></h3><p>但这并非全部，即便有了 Quorum、领导者以及追随者，还有一个诡异的问题需要解决。领导者进程可能会随意地暂停。进程的暂停原因有很多。对于支持垃圾回收的语言来说，可能存在长时间的垃圾回收暂停。如果领导者有一次长时间的垃圾回收暂停，追随者就可能会失联，领导者在暂停结束之后，会不断地给追随者发消息。与此同时，因为追随者无法收到来自领导者的心跳，它们可能会重新选出一个领导者，以便接收来自客户端的更新。如果原有领导者的请求还是正常处理，它们可能会改写掉一些更新。因此，需要有一个机制检测请求是否是来自过期的领导者。<a href="./generation-clock.html">世代时钟（Generation Clock）</a>就是用于标记和检测请求是否来自原有领导者的一种方式。世代，就是一个单调递增的数字。</p><h3 id="不同步的时钟和定序问题" tabindex="-1">不同步的时钟和定序问题 <a class="header-anchor" href="#不同步的时钟和定序问题" aria-label="Permalink to &quot;不同步的时钟和定序问题&quot;">​</a></h3><p>检测消息是来自原有的领导者还是新的领导者，这个问题是一个维护消息顺序的问题。一种显而易见的解决方案是，采用系统时间戳为一组消息定序，但是，我们不能这么做。主要原因在于，跨服务器使用系统时钟是无法保证同步的。计算机时钟的时间是由石英晶体管理，并依据晶体震荡来测量时间。</p><p>这种机制非常容易出错，因为晶体震荡可能会快，也可能会慢，因此，不同的服务器会产生不同的时间。跨服务器同步时钟，可以使用一种称为 NTP 的服务。这个服务周期性地去查看一组全局的时间服务器，然后，据此调整计算时钟。</p><p>因为这种情况出现在网络通信上，正如我们前面讨论过的那样，网络延迟可能会有很大差异，由于网络原因，时钟同步可能会造成延迟。这就会造成服务器时钟彼此偏移，经过 NTP 同步之后，甚至会出现时间倒退。因为这些计算机时钟存在的问题，时间通常是不能用于对事件定序。取而代之的是，可以使用一种简单的技术，称为 Lamport 时间戳。<a href="./generation-clock.html">世代时钟</a>就是其中一种。</p><h2 id="综合运用——一个分布式系统示例" tabindex="-1">综合运用——一个分布式系统示例 <a class="header-anchor" href="#综合运用——一个分布式系统示例" aria-label="Permalink to &quot;综合运用——一个分布式系统示例&quot;">​</a></h2><p>理解这些模式有什么用呢？接下来，我们就从头构建一个完整的系统，看看这些理解会怎样帮助我们。下面我们以一个共识系统为例。</p><h3 id="容错的共识" tabindex="-1">容错的共识 <a class="header-anchor" href="#容错的共识" aria-label="Permalink to &quot;容错的共识&quot;">​</a></h3><p>分布式共识，是分布式系统实现的一个特例，它给予了我们强一致性的保证。在常见的企业级系统中，这方面的典型例子是，<a href="https://zookeeper.apache.org/" target="_blank" rel="noreferrer">Zookeeper</a>、<a href="https://etcd.io/" target="_blank" rel="noreferrer">etcd</a> 和 <a href="https://www.consul.io/" target="_blank" rel="noreferrer">Consul</a>。它们实现了诸如 <a href="https://zookeeper.apache.org/doc/r3.4.13/zookeeperInternals.html#sc_atomicBroadcast" target="_blank" rel="noreferrer">zab</a> 和 <a href="https://raft.github.io/" target="_blank" rel="noreferrer">Raft</a> 之类的共识算法，提供了复制和强一致性。还有其它一些流行的算法实现共识机制，比如<a href="https://en.wikipedia.org/wiki/Paxos_(computer_science)" target="_blank" rel="noreferrer">Paxos</a>，<a href="https://research.google/pubs/pub27897/" target="_blank" rel="noreferrer">Google Chubby</a> 把这种算法用在了锁服务、视图戳复制和<a href="https://www.cs.cornell.edu/ken/History.pdf" target="_blank" rel="noreferrer">虚拟同步（virtual-synchrony）</a>上。简单来说，共识就是指，一组服务器就存储数据达成一致，以决定哪个数据要存储起来，什么时候数据对于客户端可见。</p><h3 id="实现共识的模式序列" tabindex="-1">实现共识的模式序列 <a class="header-anchor" href="#实现共识的模式序列" aria-label="Permalink to &quot;实现共识的模式序列&quot;">​</a></h3><p>共识实现使用<a href="https://en.wikipedia.org/wiki/State_machine_replication" target="_blank" rel="noreferrer">状态机复制（state machine replication）</a>，以达到对于失效的容忍。在状态机复制的过程中，类似于键值存储这样的存储服务是在所有服务器上进行复制，用户输入是在每个服务器上以相同的顺序执行。做到这一点，一个关键的实现技术就是在所有服务器上复制<a href="./write-ahead-log.html">预写日志（Write-Ahead Log）</a>，这样就有了可复制的 WAL。</p><p>我们按照下面的方式可以将模式放在一起去实现可复制的 WAL。</p><p>为了提供持久性的保证，要使用<a href="./write-ahead-log.html">预写日志（Write-Ahead Log）</a>。使用<a href="./segmented-log.html">分段日志（Segmented Log）</a>可以将预写日志分成多个段。这么有助于实现日志的清理，通常这会采用<a href="./low-water-mark.html">低水位标记（Low-Water Mark）</a>进行处理。通过将预写日志复制到多个服务器上，失效容忍性就得到了保障。在服务器间复制由<a href="./leader-and-followers.html">领导者和追随者（Leader and Followers）</a>保障。<a href="./quorum.html">Quorum</a> 用于更新<a href="./high-water-mark.html">高水位标记（High Water Mark）</a>，以决定哪些值对客户端可见。所有的请求都严格按照顺序进行处理，这可以通过<a href="./singular-update-queue.html">单一更新队列（Singular Update Queue）</a>实现。领导者发送请求给追随者时，使用<a href="./single-socket-channel.html">单一 Socket 通道（Single Socket Channel）</a>就可以保证顺序。要在单一 Socket 通道上优化吞吐和延迟，可以使用<a href="./request-pipeline.html">请求管道（Request Pipeline）</a>。追随者通过接受来自领导者的<a href="./heartbeat.html">心跳（HeartBeat）</a>以确定领导者的可用性。如果领导者因为网络分区的原因，临时在集群中失联，可以使用<a href="./generation-clock.html">世代时钟（Generation Clock）</a>检测出来。如果只由领导者服务所有的请求，它就可能会过载。当客户端是只读的，而且能够容忍读取到陈旧的值，追随者服务器也可以提供服务。<a href="./follower-reads.html">追随者读取（Follower Reads）</a>就允许由追随者服务器对读取请求提供服务。</p><p><img src="/patterns-of-distributed-systems/assets/pattern-sequence-for-implementing-consensus.urUSSR5K.png" alt="实现共识的模式序列"></p><h3 id="kubernetes-或-kafka-的控制平面" tabindex="-1">Kubernetes 或 Kafka 的控制平面 <a class="header-anchor" href="#kubernetes-或-kafka-的控制平面" aria-label="Permalink to &quot;Kubernetes 或 Kafka 的控制平面&quot;">​</a></h3><p>像 <a href="https://kubernetes.io/" target="_blank" rel="noreferrer">Kubernetes</a> 或 <a href="https://kafka.apache.org/" target="_blank" rel="noreferrer">Kafka</a> 这样产品的架构是围绕着一个强一致的元数据存储构建起来的。我们可以把它理解成一个模式序列。<a href="./consistent-core.html">一致性内核（Consistent Core）</a>用作一个强一致、可容错的元数据存储。<a href="./lease.html">租约（Lease）</a>用于实现集群节点的分组成员和失效检测。当集群节点失效或更新其元数据时，其它集群节点可以通过<a href="./state-watch.html">状态监控（State Watch）</a>获得通知。在网络失效重试的情况下，<a href="./consistent-core.html">一致性内核（Consistent Core）</a>的实现可以用[幂等接收者（Idempotent Receiver）]忽略集群节点发送的重复请求。<a href="./consistent-core.html">一致性内核（Consistent Core）</a>可以采用可复制的 WAL，上一节已经描述过这个模式序列了。</p><p><img src="/patterns-of-distributed-systems/assets/kubernetes-or-kafka-control-plane.C9FItq8h.png" alt="Kubernetes 或 Kafka 的控制平面"></p><h3 id="逻辑时间戳的使用" tabindex="-1">逻辑时间戳的使用 <a class="header-anchor" href="#逻辑时间戳的使用" aria-label="Permalink to &quot;逻辑时间戳的使用&quot;">​</a></h3><p>各种类型逻辑时间戳的使用也可以看作是一个模式序列。各种产品可以使用 <a href="./gossip-dissemination.html">Gossip 传播（Gossip Dissemination）</a>或<a href="./consistent-core.html">一致性内核（Consistent Core）</a>处理群集节点的分组成员和失效检测。数据存储使用<a href="./versioned-value.html">有版本的值（Versioned Value）</a>就能够确定哪个值是最新的。如果有单台服务器负责更新值，或是使用了<a href="./leader-and-followers.html">领导者和追随者（Leader and Followers）</a>，可以使用 <a href="./lamport-clock.html">Lamport 时钟（Lamport Clock）</a>当做<a href="./versioned-value.html">有版本的值（Versioned Value）</a> 中的版本。当时间戳需要从一天中时间中推导出来时，可以使用<a href="./hybrid-clock.html">混合时钟（Hybrid Clock）</a>，替代简单的 Lamport 时钟（Lamport Clock）。如果允许多台服务器处理客户端请求，更新同样的值，可以使用<a href="./version-vector.html">版本向量（Version Vector）</a>，这样能够检测出在不同集群节点上的并发写入。</p><p><img src="/patterns-of-distributed-systems/assets/logical-timestamp-usage.D17dJEWy.png" alt="逻辑时间戳的使用"></p><p>这样，以通用的形式理解问题以及其可复用的解决方案，有助于理解整个系统的构造块。</p><h2 id="下一步" tabindex="-1">下一步 <a class="header-anchor" href="#下一步" aria-label="Permalink to &quot;下一步&quot;">​</a></h2><p>分布式系统是一个巨大的话题。这里涵盖的这套模式只是其中的一小部分，它们覆盖了不同的主题，展示了一个模式能够如何帮助我们理解和设计分布式问题。我将持续在添加更多的模式，包括分布式系统中解决的下列主题：</p><ul><li>成员分组以及失效检测</li><li>分区</li><li>复制与一致性</li><li>存储</li><li>处理</li></ul></div></div></main><footer class="VPDocFooter" data-v-a5e516de data-v-3808e18b><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-3808e18b><span class="visually-hidden" id="doc-footer-aria-label" data-v-3808e18b>Pager</span><div class="pager" data-v-3808e18b><!----></div><div class="pager" data-v-3808e18b><a class="VPLink link pager-link next" href="/patterns-of-distributed-systems/content/clock-bound-wait.html" data-v-3808e18b><!--[--><span class="desc" data-v-3808e18b>Next page</span><span class="title" data-v-3808e18b>以时钟为限的等待（Clock-Bound Wait）</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-32300550 data-v-d6af7c7e><div class="container" data-v-d6af7c7e><p class="message" data-v-d6af7c7e>Released under the MIT License. Forked from dreamhead/patterns-of-distributed-systems</p><p class="copyright" data-v-d6af7c7e>Copyright © 2023-present pedrogao</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"api-examples.md\":\"DCGC9F6R\",\"content_clock-bound-wait.md\":\"BDCX-hKX\",\"content_consistent-core.md\":\"jsurQpYl\",\"content_emergent-leader.md\":\"CG6bNwn0\",\"content_fixed-partitions.md\":\"C8Tbmzbx\",\"content_follower-reads.md\":\"u_x9ndy7\",\"content_generation-clock.md\":\"glfymuta\",\"content_gossip-dissemination.md\":\"af1T816-\",\"content_heartbeat.md\":\"DkhivonN\",\"content_high-water-mark.md\":\"CnGCG8Ro\",\"content_hybrid-clock.md\":\"Do_2XUdR\",\"content_idempotent-receiver.md\":\"BfMLgZ1C\",\"content_key-range-partitions.md\":\"B9T-dYjS\",\"content_lamport-clock.md\":\"BkyZBXd0\",\"content_leader-and-followers.md\":\"DnGt_TAe\",\"content_lease.md\":\"DEyaksvq\",\"content_low-water-mark.md\":\"l-t0nfys\",\"content_overview.md\":\"ClyZ9akP\",\"content_paxos.md\":\"CAVkmhhF\",\"content_quorum.md\":\"Bf14T8KK\",\"content_replicated-log.md\":\"CnAr-Pi-\",\"content_request-batch.md\":\"BchwxFbY\",\"content_request-pipeline.md\":\"1vHw0frt\",\"content_request-waiting-list.md\":\"BYInkhzK\",\"content_segmented-log.md\":\"DTD1kYVN\",\"content_single-socket-channel.md\":\"BIlQ1-tk\",\"content_singular-update-queue.md\":\"3FQsgMX0\",\"content_state-watch.md\":\"CyX3ivjq\",\"content_two-phase-commit.md\":\"DqioFGVv\",\"content_version-vector.md\":\"CBH23IPg\",\"content_versioned-value.md\":\"OT9Wqql1\",\"content_write-ahead-log.md\":\"Bk957bF4\",\"index.md\":\"CvOBjRH2\",\"markdown-examples.md\":\"Cn6GqkcD\",\"part2_chapter 12. high-water mark_index.md\":\"t2d5Bz17\",\"part2_chapter 15. idempotent receiver_index.md\":\"DEkmLjlI\",\"part2_index.md\":\"clWpcYv-\",\"readme.md\":\"BuYq-As1\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"Patterns of Distributed Systems\",\"description\":\"《分布式系统模式》（Patterns of Distributed Systems）是 Unmesh Joshi 编写的一系列关于分布式系统实现的文章。这个系列的文章采用模式的格式，介绍了像 Kafka、Zookeeper 这种分布式系统在实现过程采用的通用模式，是学习分布式系统实现的基础。\",\"base\":\"/patterns-of-distributed-systems/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"https://martinfowler.com/articles/patterns-of-distributed-systems/card.png\",\"nav\":[{\"text\":\"主页\",\"link\":\"/\"},{\"text\":\"概述\",\"link\":\"/content/overview\"},{\"text\":\"模式\",\"items\":[{\"text\":\"以时钟为限的等待（Clock-Bound Wait）\",\"link\":\"/content/clock-bound-wait\"},{\"text\":\"一致性内核（Consistent Core）\",\"link\":\"/content/consistent-core\"},{\"text\":\"新生领导者（Emergent Leader）\",\"link\":\"/content/emergent-leader\"},{\"text\":\"固定分区（Fixed Partitions）\",\"link\":\"/content/fixed-partitions\"},{\"text\":\"追随者读取（Follower Reads）\",\"link\":\"/content/follower-reads\"},{\"text\":\"世代时钟（Generation Clock）\",\"link\":\"/content/generation-clock\"},{\"text\":\"Gossip 传播（Gossip Dissemination）\",\"link\":\"/content/gossip-dissemination\"},{\"text\":\"心跳（HeartBeat）\",\"link\":\"/content/heartbeat\"},{\"text\":\"高水位标记（High-Water Mark）\",\"link\":\"/content/high-water-mark\"},{\"text\":\"混合时钟（Hybrid Clock）\",\"link\":\"/content/hybrid-clock\"},{\"text\":\"幂等接收者（Idempotent Receiver）\",\"link\":\"/content/idempotent-receiver\"},{\"text\":\"键值范围分区（Key-Range Partitions）\",\"link\":\"/content/key-range-partitions\"},{\"text\":\"Lamport 时钟（Lamport Clock）\",\"link\":\"/content/lamport-clock\"},{\"text\":\"领导者和追随者（Leader and Followers）\",\"link\":\"/content/leader-and-followers\"},{\"text\":\"租约（Lease）\",\"link\":\"/content/lease\"},{\"text\":\"低水位标记（Low-Water Mark）\",\"link\":\"/content/low-water-mark\"},{\"text\":\"Paxos\",\"link\":\"/content/paxos\"},{\"text\":\"Quorum\",\"link\":\"/content/quorum\"},{\"text\":\"复制日志（Replicated Log）\",\"link\":\"/content/replicated-log\"},{\"text\":\"批量请求（Request Batch）\",\"link\":\"/content/request-batch\"},{\"text\":\"请求管道（Request Pipeline）\",\"link\":\"/content/request-pipeline\"},{\"text\":\"请求等待列表（Request Waiting List）\",\"link\":\"/content/request-waiting-list\"},{\"text\":\"分段日志（Segmented Log）\",\"link\":\"/content/segmented-log\"},{\"text\":\"单一 Socket 通道（Single Socket Channel）\",\"link\":\"/content/single-socket-channel\"},{\"text\":\"单一更新队列（Singular Update Queue）\",\"link\":\"/content/singular-update-queue\"},{\"text\":\"状态监控（State Watch）\",\"link\":\"/content/state-watch\"},{\"text\":\"两阶段提交（Two Phase Commit）\",\"link\":\"/content/two-phase-commit\"},{\"text\":\"版本向量（Version Vector）\",\"link\":\"/content/version-vector\"},{\"text\":\"有版本的值（Versioned Values）\",\"link\":\"/content/versioned-value\"},{\"text\":\"预写日志（Write-Ahead Log）\",\"link\":\"/content/write-ahead-log\"}]},{\"text\":\"模式（新）\",\"items\":[{\"text\":\"High-Water Mark (高水位标记)\",\"link\":\"/part2/Chapter 12. High-Water Mark\"},{\"text\":\"Idempotent Receiver（幂等接收者）\",\"link\":\"/part2/Chapter 15. Idempotent Receiver\"}]}],\"sidebar\":[{\"text\":\"模式\",\"items\":[{\"text\":\"以时钟为限的等待（Clock-Bound Wait）\",\"link\":\"/content/clock-bound-wait\"},{\"text\":\"一致性内核（Consistent Core）\",\"link\":\"/content/consistent-core\"},{\"text\":\"新生领导者（Emergent Leader）\",\"link\":\"/content/emergent-leader\"},{\"text\":\"固定分区（Fixed Partitions）\",\"link\":\"/content/fixed-partitions\"},{\"text\":\"追随者读取（Follower Reads）\",\"link\":\"/content/follower-reads\"},{\"text\":\"世代时钟（Generation Clock）\",\"link\":\"/content/generation-clock\"},{\"text\":\"Gossip 传播（Gossip Dissemination）\",\"link\":\"/content/gossip-dissemination\"},{\"text\":\"心跳（HeartBeat）\",\"link\":\"/content/heartbeat\"},{\"text\":\"高水位标记（High-Water Mark）\",\"link\":\"/content/high-water-mark\"},{\"text\":\"混合时钟（Hybrid Clock）\",\"link\":\"/content/hybrid-clock\"},{\"text\":\"幂等接收者（Idempotent Receiver）\",\"link\":\"/content/idempotent-receiver\"},{\"text\":\"键值范围分区（Key-Range Partitions）\",\"link\":\"/content/key-range-partitions\"},{\"text\":\"Lamport 时钟（Lamport Clock）\",\"link\":\"/content/lamport-clock\"},{\"text\":\"领导者和追随者（Leader and Followers）\",\"link\":\"/content/leader-and-followers\"},{\"text\":\"租约（Lease）\",\"link\":\"/content/lease\"},{\"text\":\"低水位标记（Low-Water Mark）\",\"link\":\"/content/low-water-mark\"},{\"text\":\"Paxos\",\"link\":\"/content/paxos\"},{\"text\":\"Quorum\",\"link\":\"/content/quorum\"},{\"text\":\"复制日志（Replicated Log）\",\"link\":\"/content/replicated-log\"},{\"text\":\"批量请求（Request Batch）\",\"link\":\"/content/request-batch\"},{\"text\":\"请求管道（Request Pipeline）\",\"link\":\"/content/request-pipeline\"},{\"text\":\"请求等待列表（Request Waiting List）\",\"link\":\"/content/request-waiting-list\"},{\"text\":\"分段日志（Segmented Log）\",\"link\":\"/content/segmented-log\"},{\"text\":\"单一 Socket 通道（Single Socket Channel）\",\"link\":\"/content/single-socket-channel\"},{\"text\":\"单一更新队列（Singular Update Queue）\",\"link\":\"/content/singular-update-queue\"},{\"text\":\"状态监控（State Watch）\",\"link\":\"/content/state-watch\"},{\"text\":\"两阶段提交（Two Phase Commit）\",\"link\":\"/content/two-phase-commit\"},{\"text\":\"版本向量（Version Vector）\",\"link\":\"/content/version-vector\"},{\"text\":\"有版本的值（Versioned Values）\",\"link\":\"/content/versioned-value\"},{\"text\":\"预写日志（Write-Ahead Log）\",\"link\":\"/content/write-ahead-log\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/pedrogao/patterns-of-distributed-systems\"}],\"footer\":{\"message\":\"Released under the MIT License. Forked from dreamhead/patterns-of-distributed-systems\",\"copyright\":\"Copyright © 2023-present pedrogao\"},\"search\":{\"provider\":\"local\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>
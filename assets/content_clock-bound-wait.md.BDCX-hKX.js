import{_ as i,c as a,a4 as n,o as t}from"./chunks/framework.DDPRMxUp.js";const l="/patterns-of-distributed-systems/assets/clock-bound1.sOLodngV.png",k="/patterns-of-distributed-systems/assets/clock-bound2.CN_RvlM3.png",p="/patterns-of-distributed-systems/assets/clock-bound3.DFhfR_8O.png",h="/patterns-of-distributed-systems/assets/clock-bound4.C99fkDGu.png",e="/patterns-of-distributed-systems/assets/clock-bound5.BxvCkt8C.png",r="/patterns-of-distributed-systems/assets/clock-bound6.0gGQ2dHL.png",E="/patterns-of-distributed-systems/assets/clock-bound7.BNKGbMke.png",d="/patterns-of-distributed-systems/assets/clock-bound8.BJKDGxcT.png",g="/patterns-of-distributed-systems/assets/clock-bound9.DEqHCiu0.png",y="/patterns-of-distributed-systems/assets/clock-bound10.C4hUbDxC.png",o="/patterns-of-distributed-systems/assets/clock-bound11.BiGKx0L9.png",c="/patterns-of-distributed-systems/assets/clock-bound12.K532NY4W.png",F="/patterns-of-distributed-systems/assets/clock-bound13.B-Bl5bhs.png",f=JSON.parse('{"title":"以时钟为限的等待（Clock-Bound Wait）","description":"","frontmatter":{},"headers":[],"relativePath":"content/clock-bound-wait.md","filePath":"content/clock-bound-wait.md"}'),m={name:"content/clock-bound-wait.md"};function u(A,s,b,B,C,D){return t(),a("div",null,s[0]||(s[0]=[n('<h1 id="以时钟为限的等待-clock-bound-wait" tabindex="-1">以时钟为限的等待（Clock-Bound Wait） <a class="header-anchor" href="#以时钟为限的等待-clock-bound-wait" aria-label="Permalink to &quot;以时钟为限的等待（Clock-Bound Wait）&quot;">​</a></h1><p><strong>原文</strong></p><p><a href="https://martinfowler.com/articles/patterns-of-distributed-systems/clock-bound.html" target="_blank" rel="noreferrer">https://martinfowler.com/articles/patterns-of-distributed-systems/clock-bound.html</a></p><p>集群节点之间存在<strong>时间不确定性</strong>，因此需要在<strong>读取</strong>和<strong>写入</strong>之前等待，以使<strong>值</strong>能在集群节点之间正确排序。</p><p><strong>2022.8.17</strong></p><h2 id="问题" tabindex="-1">问题 <a class="header-anchor" href="#问题" aria-label="Permalink to &quot;问题&quot;">​</a></h2><p>考虑一个 KV（键值）存储，其中存储<strong>V</strong>时携带<strong>时间戳</strong>来区别每个版本。</p><p>客户端请求集群任何节点时，携带客户端的当前时间戳就能读取到<strong>V</strong>的最新版本。</p><p>如下面例子所示，按照格林时钟，值<code>Before Dawn</code>在时刻<strong>2</strong>时被更新为<code>After Dawn</code>。</p><p>Alice 和 Bob 都尝试读取<code>title</code>的最新版本值。 Alice 的请求由集群节点 Amber 处理，Bob 的请求由集群节点 Blue 处理。 节点 Amber 的时钟滞后，处于时刻<strong>1</strong>； 这意味着当 Alice 读取最新值时，节点会返回<code>Before Dawn</code>。 节点 Blue 时钟为时刻<strong>2</strong>；当 Bob 读取最新值时，返回值为<code>After Dawn</code>。</p><blockquote><p>Alice 和 Bob 都可以向格林时钟服务器获取<code>key</code>的最新版本时间戳；但这需要额外一轮请求。 如果 Alice 和 Bob 尝试从多个服务器节点中读取多个<code>key</code>，需要获取每个<code>key</code>的最新版本并选取最新版本的值。</p></blockquote><p><img src="'+l+'" alt="clock-bound1"></p><p>这违反了<a href="https://cloud.google.com/spanner/docs/true-time-external-consistency" target="_blank" rel="noreferrer">外部一致性</a>。 如果 Alice 和 Bob 正在打电话沟通，Alice 会很困惑； Bob 会说<code>title</code>的最新值是<code>After Dawn</code>，而 Alice 的节点显示的<code>title</code>仍然是<code>Before Dawn</code>。</p><p>似乎节点 Blue 的值写入发生在”未来“。</p><p>如果以<strong>系统时间戳</strong>作为存储值的版本，就会引起这样的问题，因为<a href="https://martinfowler.com/articles/patterns-of-distributed-systems/time-bound-lease.html#wall-clock-not-monotonic" target="_blank" rel="noreferrer">系统时钟不是单调的</a>。 来自不同服务器节点的时钟值不能也不应该进行比较。 当<a href="./hybrid-clock.html">混合时钟</a>用作<a href="./versioned-value.html">版本值</a>中的版本时，就能在单个服务器、以及因果相关的不同服务器上进行版本排序。 然而，混合时钟（或者任何基于 <a href="./lamport-clock.html">Lamport Clock</a> 的时钟实现）都只能给出<a href="https://martinfowler.com/articles/patterns-of-distributed-systems/lamport-clock.html#PartialOrder" target="_blank" rel="noreferrer">部分顺序（partial order）</a>。 这就意味着不存在因果关系且分布在不同节点上值是无法排序的。 当使用<strong>时间戳</strong>读取集群不同节点值时，会引起问题：如果读取时钟滞后节点，那么节点可能无法返回值的最新版本。</p><h2 id="解决方案" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案" aria-label="Permalink to &quot;解决方案&quot;">​</a></h2><p>读取或写入值时，集群节点会陷入等待，直到集群中每个节点上的时间戳都高于请求时间戳。</p><p>如果时钟之间的间隔非常小，则写入请求可以等待，且不会造成大量开销。 例如，假设集群节点之间的最大时钟间隔为 <code>10 ms</code>。（这意味着，在任何时间点，集群中最慢的节点时钟落后 10ms。） 为了保证每个集群节点的时钟戳都大于<code>t</code>，处理写操作的节点需要在存储值之前等待 10ms。</p><p>一个具有<a href="./versioned-value.html">版本</a>的 KV 存储，每个更新操作都是一个追加操作，并使用时间戳作为版本号。 在上面提到的 Alice 和 Bob 例子中，写入<code>title@2</code>的操作将等待集群所有节点的时钟戳都处于 2。 这确保 Alice 始终会看到<code>title</code>的最新值，即使该节点时钟戳落后于其它节点。</p><p>考虑一个稍微不同的场景。 格林时间为<code>2</code>，Philip 正在将<code>title</code>更新为&#39;After Dawn&#39;。 Green 知道，此时写入可能有一台服务器的时间落后 1 个单位。因此，它必须在写入操作中等待 1 个单位时间。</p><p><img src="'+k+'" alt="clock-bound2"></p><p>当 Philip 在更新<code>title</code>时，Bob 正在读取<code>title</code>，且读取请求由节点 Blue 处理。 节点 Blue 时间处于 2，因此它尝试读取时间戳为 2 的<code>title</code>。 此时节点 Green 尚未提供可用的值。 这意味着 Bob 读取到了小于时间戳 2 的值，即&#39;Before Dawn&#39;。</p><p><img src="'+p+'" alt="clock-bound3"></p><p>Alice 的读取请求由节点 Amber 处理。 节点 Amber 的时间戳为 1，因此它尝试读取时间戳 1 处的<code>title</code>。Alice 读取到值&#39;Before Dawn&#39;。</p><p><img src="'+h+'" alt="clock-bound4"></p><p>一旦 Philip 的写入完成（max_diff 的等待结束后），如果 Bob 现在发送新的读取请求，节点 Blue 将尝试根据其时间戳读取最新值（时间戳已到 3）； 这将返回值&#39;After Dawn&#39;。</p><p><img src="'+e+'" alt="clock-bound5"></p><p>如果 Alice 发起一个新的读取请求，节点 Blue 将根据其时间戳（现在为 2）读取<code>title</code>最新值。因此，它也会返回值&#39;After Dawn&#39;。</p><p><img src="'+r+`" alt="clock-bound6"></p><p>解决方案的主要问题是，使用普通可用的日期/时间硬件和操作系统 API 根本不可能获得集群节点之间的准确时间差。</p><p>因此 Google 有自己的专门日期时间 API，称为 <a href="https://cloud.google.com/spanner/docs/true-time-external-consistency" target="_blank" rel="noreferrer">True Time</a>。 同样，亚马逊有 <a href="https://aws.amazon.com/about-aws/whats-new/2021/11/amazon-time-sync-service-generate-compare-timestamps/" target="_blank" rel="noreferrer">AWS 时间同步服务</a>和一个名为 <a href="https://github.com/aws/clock-bound" target="_blank" rel="noreferrer">ClockBound</a>的库。 然而，这些 API 是针对 Google 和 Amazon 的，其它企业和组织无法使用。</p><p>通常 KV 存储使用<a href="./hybrid-clock.html">混合时钟</a>来实现<a href="./versioned-value.html">版本化</a>。 虽然这也不可能获得时钟之间的确切差异，但可以根据历史观察选择合理的默认值。 观察发现，跨数据中心的服务器上的最大时钟偏差的通常为 200 到 500 ms。</p><p>KV 存储在存储值之前需要等待最大时钟偏差（可配置）。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> KVStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxOffset </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  NavigableMap&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">HybridClockKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; kv </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ConcurrentSkipListMap&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      HybridTimestamp writeTimestamp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> clock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      waitTillSlowestClockCatchesUp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writeTimestamp);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      kv.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HybridClockKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, writeTimestamp), value);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> waitTillSlowestClockCatchesUp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HybridTimestamp </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">writeTimestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> waitUntilTimestamp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> writeTimestamp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(maxOffset, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      sleepUntil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(waitUntilTimestamp);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sleepUntil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HybridTimestamp </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">waitUntil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      HybridTimestamp now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> clock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (clock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">before</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(waitUntil)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> waitTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (waitUntil.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getWallClockTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> now.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getWallClockTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) ;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          Uninterruptibles.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleepUninterruptibly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(waitTime, TimeUnit.MILLISECONDS);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> clock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, HybridTimestamp </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">readTimestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> kv.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HybridClockKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, readTimestamp));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="再次读取-read-restart" tabindex="-1">再次读取（Read Restart） <a class="header-anchor" href="#再次读取-read-restart" aria-label="Permalink to &quot;再次读取（Read Restart）&quot;">​</a></h3><p>200 ms 的等待对于每个写入请求的耗时而言太长了。 这就是为什么 <a href="https://www.cockroachlabs.com/docs/stable/" target="_blank" rel="noreferrer">CockroachDB</a> 或 <a href="https://www.yugabyte.com/" target="_blank" rel="noreferrer">YugabyteDB</a> 这类数据库会改成在读取请求中检查。</p><p>当节点处理读取请求时，节点会检查在 <code>readTimestamp</code> 和 <code>readTimestamp + maximum clock</code>的时间间隔内是否有可用的数据版本。 如果可用版本的时间戳滞后，节点会要求客户端使用该版本重新读取。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> KVStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      HybridTimestamp writeTimestamp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> clock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      kv.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HybridClockKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, writeTimestamp), value);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, HybridTimestamp </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">readTimestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      checksIfVersionInUncertaintyInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, readTimestamp);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> kv.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floorEntry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HybridClockKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, readTimestamp)).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> checksIfVersionInUncertaintyInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, HybridTimestamp </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">readTimestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      HybridTimestamp uncertaintyLimit </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> readTimestamp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(maxOffset, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      HybridClockKey versionedKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> kv.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floorKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HybridClockKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, uncertaintyLimit));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (versionedKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      HybridTimestamp maxVersionBelowUncertainty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> versionedKey.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (maxVersionBelowUncertainty.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">after</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(readTimestamp)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ReadRestartException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(readTimestamp, maxOffset, maxVersionBelowUncertainty);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Client</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> attemptNo </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxAttempts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(attemptNo </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxAttempts) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              HybridTimestamp now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> clock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">              return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> kvStore.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, now);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ReadRestartException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; Got read restart error &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Attempt No. &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> attemptNo);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              Uninterruptibles.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleepUninterruptibly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(e.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMaxOffset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), TimeUnit.MILLISECONDS);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              attemptNo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ReadTimeoutException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Unable to read after &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> attemptNo </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot; attempts.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>在上面的 Alice 和 Bob 例子中，如果在时间戳 2 处存在可用的<code>title</code>版本， 并且 Alice 发送时间戳为 1 的读取请求，则节点抛出 <code>ReadRestartException</code>，要求 Alice 以时间戳 2 为请求时间戳重新发起读取请求。</p><p><img src="`+E+`" alt="clock-bound7"></p><p>仅当在<code>不确定时间区间</code>内写入版本时，才会发生<strong>再次读取</strong>的问题。而写请求不需要等待。</p><p>但要记住的是，<code>maximum clock</code>偏差的配置项是一个假设，不能保证。 在某些情况下，不良的服务器的时钟偏差可能超过假定值，在这种情况下，<a href="https://docs.yugabyte.com/preview/benchmark/resilience/jepsen-testing-ysql/#rare-occurrence-of-causal-reversal" target="_blank" rel="noreferrer">一致性问题仍然存在</a>。</p><h3 id="使用时钟绑定-api-using-clock-bound-apis" tabindex="-1">使用时钟绑定 API（Using Clock Bound APIs） <a class="header-anchor" href="#使用时钟绑定-api-using-clock-bound-apis" aria-label="Permalink to &quot;使用时钟绑定 API（Using Clock Bound APIs）&quot;">​</a></h3><p>谷歌和亚马逊等云提供商使用原子钟和 GPS 来实现时钟机制，以确保集群节点之间的时钟偏差保持在几毫秒以下。 正如我们刚才讨论的，谷歌拥有 True Time，AWS 拥有 AWS Time Sync Service 和 ClockBound。</p><p>为了确保正确实现读、写等待，集群节点有两个关键要求：</p><ul><li>集群节点之间的时钟偏差保持在最低， Google 的 True Time 在大多数情况下将其保持在 1 ms 以下（最坏情况下为 7 ms）；</li><li>时钟偏差能在日期/时间 API 中返回，确保使用者不需要猜测偏差值。</li></ul><p>集群节点上的时钟机制能够计算日期时间值的误差范围。 本地系统时钟 API 能够返回时间偏差，给出时间偏差的下限和上限，从而保证实时值在此区间内。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ClockBound</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> earliest;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> latest;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ClockBound</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> earliest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> latest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.earliest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> earliest;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.latest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> latest;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> boolean</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> before</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> timestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> timestamp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> earliest;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> boolean</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> after</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> timestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)   {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> timestamp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> latest;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>正如本 <a href="https://aws.amazon.com/blogs/mt/manage-amazon-ec2-instance-clock-accuracy-using-amazon-time-sync-service-and-amazon-cloudwatch-part-1/" target="_blank" rel="noreferrer">AWS 博客</a>中所述，每个节点的时钟无法为<code>ClockErrorBound</code>。 实时值在本地时钟时间（t）上下波动，将始终介于<code>[t -ClockErrorBound, t + ClockErrorBound]</code>之间。</p><p>调用日期时间 API 时，会返回时间误差范围：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ClockBound </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> now;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>时钟绑定 API 保证了两个属性：</p><ul><li>时钟范围应该在集群节点之间重叠；</li><li>对于两个时间值 t1 和 t2，如果 t1 小于 t2，则所有集群节点上的 clock_bound(t1).earliest 都小于 clock_bound(t2).latest</li></ul><p>假设集群有三个节点：Green, Blue 和 Orange。 每个节点可能有不同的时钟错误偏差。 假设节点 Green 上的误差为 1，节点 Blue 为 2，节点 Orange 为 3。 在 time=4 时，跨集群节点的时钟绑定如下图所示：</p><p><img src="`+d+`" alt="clock-bound8"></p><p>在这种情况下，需要遵循两个规则来实现提交等待：</p><ul><li>对于任何写入操作，应选择时钟范围的最新值作为时间戳。 这将确保它始终高于分配给先前写入操作的任何时间戳（考虑下面的第二条规则）；</li><li>系统必须等到写入时间戳小于时钟范围的最早值，然后才能存储该值。</li></ul><p>这是因为所有节点上的最早值保证低于时钟界限的最新值。 任何读取时钟且绑定最新值的请求都可以访问此写入操作的值，此外，在发生任何其他写入操作之前，该值是有序的。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> KVStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ClockBound now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boundedClock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> writeTimestamp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> now.latest;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      addPending</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writeTimestamp);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      waitUntilTimeInPast</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writeTimestamp);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      kv.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VersionedKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, writeTimestamp), value);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      removePending</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writeTimestamp);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> waitUntilTimeInPast</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> writeTimestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ClockBound now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boundedClock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(now.earliest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> writeTimestamp) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          Uninterruptibles.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleepUninterruptibly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(now.earliest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> writeTimestamp, TimeUnit.MILLISECONDS);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boundedClock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> removePending</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> writeTimestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      pendingWriteTimestamps.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writeTimestamp);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          lock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          cond.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">signalAll</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          lock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> addPending</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> writeTimestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      pendingWriteTimestamps.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(writeTimestamp);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><p>TODO:翻译</p><p>如果我们回到上面的 Alice 和 Bob 示例，当 Philip 在服务器 Green 上写入“title”的值 - “After Dawn”时，Green 上的 put 操作将等待，直到所选的写入时间戳低于服务器 Green 的最早值。 时钟绑定。 这保证了每个其他集群节点都具有更高的时钟边界最新值的时间戳。 为了说明这一点，考虑这种情况。 绿色的误差范围为+-1。 因此，对于从时间 4 开始的 put 操作，当它存储值时，Green 将拾取时钟边界的最新值，即 5。然后它会等待，直到时钟边界的最早值大于 5。本质上， Green 在将值实际存储到键值存储中之前等待不确定性间隔。</p><p><img src="`+g+'" alt="clock-bound9"></p><p>当该值在键值存储中可用时，每个集群节点上时钟边界的最新值都保证高于 5。 这意味着 Blue 处理的 Bob 请求以及 Amber 处理的 Alice 请求都可以保证获得最新的标题值。</p><p><img src="'+y+'" alt="clock-bound10"></p><p><img src="'+o+'" alt="clock-bound11"></p><p>如果格林有“更宽”的时间范围，我们会得到相同的结果。 错误界限越大，等待的时间就越长。 如果 Green 的错误界限达到最大值，它将继续等待，然后再使值在键值存储中可用。 Amber 和 Blue 都无法获取该值，直到它们的最新时间值超过 7。当 Alice 在最晚时间 7 获取最新的 title 值时，将保证每个其他集群节点都能在它的时间获取该值。 最新时间值。</p><p><img src="'+c+`" alt="clock-bound12"></p><h3 id="读等待-read-wait" tabindex="-1">读等待（Read Wait） <a class="header-anchor" href="#读等待-read-wait" aria-label="Permalink to &quot;读等待（Read Wait）&quot;">​</a></h3><p>当读取该值时，客户端将始终从其集群节点的时钟范围中选择最大值。</p><p>接收请求的集群节点需要确保一旦在特定请求时间戳返回响应，则在该时间戳或较低时间戳处没有写入任何值。</p><p>如果请求中的时间戳高于服务器上的时间戳，集群节点将等待时钟赶上，然后再返回响应。</p><p>然后，它将检查较低时间戳处是否有任何尚未存储的待处理写入请求。 如果有，则读取请求将暂停，直到请求完成。</p><p>然后，服务器将读取请求时间戳处的值并返回该值。 这确保了一旦在特定时间戳返回响应，就不会在较低时间戳写入任何值。 这种保证称为快照隔离</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> KVStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Lock lock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ReentrantLock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Queue&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; pendingWriteTimestamps </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ArrayDeque&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Condition cond  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newCondition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Optional&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> readTimestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      waitUntilTimeInPast</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(readTimestamp);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      waitForPendingWrites</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(readTimestamp);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      Optional&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VersionedKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; max </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> kv.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">keySet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Comparator.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">naturalOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(max.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isPresent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Optional.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(kv.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(max.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Optional.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">empty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> waitForPendingWrites</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> readTimestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          lock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (pendingWriteTimestamps.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">anyMatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> readTimestamp)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              cond.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">awaitUninterruptibly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          lock.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>考虑最后一个场景：Alice 的读取请求由服务器 Amber 处理，错误界限为 3。它选取读取标题的最新时间为 7。 同时，Philip 的写请求由 Green 处理（错误界限为+-1），它选取 5 来存储该值。 Alice 的读请求会等待，直到格林的最早时间超过 7 点，并且挂起的写请求。 然后它返回时间戳低于 7 的最新值。</p><p><img src="`+F+'" alt="clock-bound13"></p><h2 id="示例" tabindex="-1">示例 <a class="header-anchor" href="#示例" aria-label="Permalink to &quot;示例&quot;">​</a></h2><ul><li>Google 的 <a href="https://cloud.google.com/spanner/docs/true-time-external-consistency" target="_blank" rel="noreferrer">TrueTime API</a> 提供了时钟绑定。 <a href="https://cloud.google.com/spanner" target="_blank" rel="noreferrer">Spanner</a> 用它来实现 commit-wait。</li><li><a href="https://aws.amazon.com/about-aws/whats-new/2021/11/amazon-time-sync-service-generate-compare-timestamps/" target="_blank" rel="noreferrer">AWS Time Sync Service</a> 可确保最小的时钟偏差。 可以使用<a href="https://github.com/aws/clock-bound" target="_blank" rel="noreferrer"> ClockBound API</a> 来实现等待以对集群中的事件进行排序。</li><li><a href="https://www.cockroachlabs.com/docs/stable/" target="_blank" rel="noreferrer">CockroachDB</a> 实现了 read start。 它还具有一个实验性选项，可以根据配置的最大时钟偏差值使用 commit-wait。</li><li><a href="https://www.yugabyte.com/" target="_blank" rel="noreferrer">YugabyteDB</a> 根据配置的最大时钟误差值实现 read start。</li></ul>',79)]))}const v=i(m,[["render",u]]);export{f as __pageData,v as default};
